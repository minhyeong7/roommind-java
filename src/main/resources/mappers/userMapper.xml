<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.roomgenius.furniture_recommendation.mapper.UserMapper">

    <!-- Result Map: DB 컬럼명(camelCase)과 정확히 일치 -->
    <resultMap id="UserResultMap" type="com.roomgenius.furniture_recommendation.entity.UserVO">
        <id property="userId" column="userId"/>
        <result property="userName" column="userName"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="email" column="email"/>
        <result property="password" column="password"/>
        <result property="socialType" column="socialType"/>
        <result property="socialId" column="socialId"/>
        <result property="role" column="role"/>
        <result property="createdDate" column="createdDate"/>
        <result property="updatedDate" column="updatedDate"/>
    </resultMap>

    <!-- 회원가입 (일반 + 소셜 공용) -->
    <insert id="insertUser"
            parameterType="com.roomgenius.furniture_recommendation.entity.UserVO"
            useGeneratedKeys="true"
            keyProperty="userId">
        INSERT INTO Users
        (userName, phone, address, email, password, socialType, socialId, role)
        VALUES
        (#{userName}, #{phone}, #{address}, #{email}, #{password},
        #{socialType}, #{socialId}, COALESCE(#{role}, 'user'))
    </insert>

    <!-- 이메일 중복 체크 -->
    <select id="countByEmail" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM Users
        WHERE email = #{email}
    </select>

    <!-- ID로 회원 조회 -->
    <select id="findById" resultMap="UserResultMap" parameterType="int">
        SELECT userId, userName, phone, address, email, password,
        socialType, socialId, role, createdDate, updatedDate
        FROM Users
        WHERE userId = #{userId}
    </select>

    <!-- 이메일로 회원 조회 (일반 로그인용) -->
    <select id="findByEmail" resultMap="UserResultMap" parameterType="string">
        SELECT userId, userName, phone, address, email, password,
        socialType, socialId, role, createdDate, updatedDate
        FROM Users
        WHERE email = #{email}
    </select>

    <!-- 소셜 로그인용 조회 (socialId + socialType) -->
    <select id="findBySocial" resultMap="UserResultMap" parameterType="map">
        SELECT userId, userName, phone, address, email, password,
        socialType, socialId, role, createdDate, updatedDate
        FROM Users
        WHERE socialId = #{socialId}
        AND socialType = #{socialType}
    </select>

</mapper>